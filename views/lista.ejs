<%- include('includes/head.ejs')%>

<h1 id="titulo">Este es un sitio de Instrumentos Musicales</h1>
<h5>Tenemos los siguientes instrumentos: </h5>

<label for="buscar">Buscar:</label>
<input type="text" name="buscar" id="buscar">

<div class="row" id="respuesta_ajax">       <!--Se divide la página en 3 partes dentro del grid, para poner las 3 tarjetas alineadas-->
    <% if (instrumentos.length > 0) { %>     <!-- // Tenemos acceso a instrumentos_array porque se envía desde el controller -->
        <ul>
        <% for (let inst of instrumentos) { %>
        <div class="col l3 m4 s12">
            <div class="card">
                <div class="card-image waves-effect waves-block waves-light">
                    <img class="activator" src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fst3.depositphotos.com%2F4897955%2F14447%2Fv%2F950%2Fdepositphotos_144479889-stock-illustration-musical-instruments-design-set-monochrome.jpg&f=1&nofb=1">
                </div>
                <div class="card-content">
                    <span class="card-title activator grey-text text-darken-4"><%=inst.nombre %><i class="material-icons right">more_vert</i></span>
                    <p><a href="#">Saber más</a></p>
                </div>
                <div class="card-reveal">
                    <span class="card-title grey-text text-darken-4"><%=inst.nombre %><i class="material-icons right">close</i></span>
                    <p><%=inst.descripcion %></p>
                  </div>
            </div>
        </div>
        <% } %>
        </ul>
    <% } else { %>
            <h3>Por el momento no contamos con ningun instrumento.</h3>
    <% } %>
</div>
<div id="ultimo_inst">
    <% if (ultimo_instrumento != '') { %>
        <p> El instrumento más recientemente agregado fue: <%= ultimo_instrumento %></p> 
        <br>
   <% } %>
</div> 

<script>
const accion_asincrona = () => {
    const valor_busqueda = document.getElementById('buscar').value;

    //El token de protección CSRF. Solo se usa con peticiones POST
    //const csrf = document.getElementById('_csrf').value;

    //función que manda la petición asíncrona
    fetch('/musica/instrumentos/busqueda/'+valor_busqueda, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            //'csrf-token': csrf
        }
        //body: JSON.stringify(data)    // No tiene body por ser GET
    }).then(result => {
        return result.json(); //Regresa otra promesa
    }).then(data => {
        let respuesta = '';
        for (let inst of data){
              respuesta += '<div class="col l3 m4 s12">' +
             '<div class="card">' +
                 '<div class="card-image waves-effect waves-block waves-light">' +
                     '<img class="activator" src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fst3.depositphotos.com%2F4897955%2F14447%2Fv%2F950%2Fdepositphotos_144479889-stock-illustration-musical-instruments-design-set-monochrome.jpg&f=1&nofb=1">' +
                 '</div>' +
                 '<div class="card-content">' +
                     '<span class="card-title activator grey-text text-darken-4">'+ inst.nombre +'<i class="material-icons right">more_vert</i></span>' +
                     '<p><a href="#">Saber más</a></p>' +
                 '</div>' +
                 '<div class="card-reveal">' +
                     '<span class="card-title grey-text text-darken-4">'+ inst.nombre +'<i class="material-icons right">close</i></span>' +
                     '<p>'+ inst.descripcion +
                  '</div>' +
            '</div>' +
         '</div>';
        }

        console.log(respuesta);
        document.getElementById('respuesta_ajax').innerHTML = respuesta;
        
    }).catch(err => {
        console.log(err);
    });
};

document.getElementById('buscar').onkeyup = accion_asincrona;
</script>            

  <%-include('includes/foot.ejs')%>